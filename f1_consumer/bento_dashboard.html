<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Lights Out - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    
    <style>
        /* üé® THEME ENGINE */
        :root {
            --brand-color: #4f46e5; 
            --brand-glow: rgba(79, 70, 229, 0.4);
            --bg-page: #09090b;       
            --bg-card: #18181b;       
            --border-color: #27272a;  
            --text-main: #ffffff;     
            --text-sub: #a1a1aa;      
            --text-muted: #52525b;    
            --shadow: 0 8px 30px rgba(0,0,0,0.5);
            --map-bg: #111113;
        }

        [data-theme="light"] {
            --bg-page: #f4f4f5;       
            --bg-card: #ffffff;       
            --border-color: #e4e4e7;  
            --text-main: #09090b;     
            --text-sub: #52525b;      
            --text-muted: #a1a1aa;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --map-bg: #f8fafc;
        }

        * { box-sizing: border-box; transition: background-color 0.3s ease, color 0.2s ease, border-color 0.3s ease; }

        body {
            background-color: var(--bg-page);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 24px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            width: 100%; max-width: 1400px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0 10px;
        }
        .project-title { font-weight: 900; font-size: 24px; letter-spacing: -0.05em; }
        .theme-toggle {
            background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main);
            padding: 10px 16px; border-radius: 99px; cursor: pointer; font-weight: 600;
            display: flex; align-items: center; gap: 8px; font-size: 14px;
        }

        /* GRID */
        .grid-container {
            display: grid; gap: 24px; width: 100%; max-width: 1400px; grid-template-columns: 1fr;
        }
        @media (min-width: 768px) { .grid-container { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1200px) { 
            .grid-container { grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 340px); }
            .card-map { grid-column: span 2; grid-row: span 2; }
            .card-vehicle { grid-column: span 1; grid-row: span 2; }
        }

        /* CARD */
        .card {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 24px;
            padding: 32px; display: flex; flex-direction: column; box-shadow: var(--shadow);
            position: relative; overflow: hidden;
        }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .card-label { font-size: 13px; font-weight: 700; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; }
        
        /* TYPOGRAPHY */
        .stat-value { font-family: 'JetBrains Mono', monospace; font-weight: 800; color: var(--text-main); line-height: 0.9; letter-spacing: -0.05em; }
        .stat-huge { font-size: clamp(80px, 8vw, 120px); } 
        .stat-large { font-size: clamp(40px, 4vw, 60px); }
        .stat-med { font-size: 28px; }
        .unit { font-size: 16px; color: var(--text-sub); font-weight: 500; margin-top: 10px; display: block; }

        /* üó∫Ô∏è MAP COMPONENT (Updated) */
        .map-area {
            flex-grow: 1; 
            background-color: var(--map-bg); 
            border-radius: 16px; 
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            /* Grid Pattern */
            background-image: 
                linear-gradient(var(--border-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .map-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-sub);
            background: var(--bg-card);
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            backdrop-filter: blur(4px);
        }

        /* GEAR & BARS */
        .gear-circle {
            width: 100px; height: 100px; border: 4px solid var(--brand-color); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 20px auto;
            color: var(--brand-color); box-shadow: 0 0 20px var(--brand-glow);
        }
        .bar-wrapper { margin-top: auto; display: flex; flex-direction: column; gap: 15px; }
        .bar-label { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; }
        .bar-bg { height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; border-radius: 4px; transition: width 0.05s linear; }
        .fill-primary { background: var(--text-main); }
        .fill-accent { background: var(--brand-color); }
        
        .sys-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; }
        .sys-item { background: var(--bg-page); padding: 20px; border-radius: 16px; }
        .sys-label { font-size: 12px; color: var(--text-sub); font-weight: 600; }
        .sys-val { margin-top: 8px; display: block; }

        .live-tag { background: var(--brand-color); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; margin-right: 5px; }
        .status-connected { background: #10b981; box-shadow: 0 0 10px #10b981; }

    </style>
</head>
<body>

    <div class="header">
        <div class="project-title">PROJECT <span style="color: var(--brand-color);">LIGHTS OUT</span></div>
        <button class="theme-toggle" onclick="toggleTheme()">
            <span id="theme-icon">‚òÄÔ∏é</span> 
            <span id="theme-text">Light Mode</span>
        </button>
    </div>

    <div class="grid-container">
        
        <div class="card card-map">
            <div class="card-header">
                <span class="card-label">Real-time Visualization</span>
                <span class="live-tag"><span class="status-dot" id="ws-status"></span>LIVE FEED</span>
            </div>
            <div class="map-area" id="map-container">
                <canvas id="trackCanvas"></canvas>
                <div class="map-overlay" id="xyz-val">Initializing Radar...</div>
            </div>
        </div>

        <div class="card card-vehicle">
            <div class="card-header"><span class="card-label">Telemetry</span></div>
            <div style="text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                <div class="stat-value stat-huge" id="speed">0</div>
                <span class="unit">KM/H</span>
                <div class="gear-circle stat-value stat-large" id="gear">N</div>
            </div>
            <div class="bar-wrapper">
                <div>
                    <div class="bar-label"><span>THROTTLE</span> <span id="thr-val">0%</span></div>
                    <div class="bar-bg"><div class="bar-fill fill-primary" id="thr-bar"></div></div>
                </div>
                <div>
                    <div class="bar-label"><span>BRAKE</span> <span id="brk-val">0%</span></div>
                    <div class="bar-bg"><div class="bar-fill fill-accent" id="brk-bar"></div></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><span class="card-label">System Architecture</span></div>
            <div class="sys-grid">
                <div class="sys-item">
                    <span class="sys-label">Throughput (Client)</span>
                    <span class="stat-value stat-med sys-val" id="tps">0</span>
                    <span class="unit" style="font-size: 12px; margin-top: 4px;">MSG/SEC</span>
                </div>
                <div class="sys-item">
                    <span class="sys-label">Latency (P99)</span>
                    <span class="stat-value stat-med sys-val">0.01</span>
                    <span class="unit" style="font-size: 12px; margin-top: 4px;">MS</span>
                </div>
            </div>
            <div style="margin-top: 20px;">
                 <span class="sys-label">Active Protocol</span>
                 <div style="margin-top: 10px; font-family: 'JetBrains Mono'; font-weight: 700; color: var(--brand-color);">
                    > RUST_ASYNC_STREAM
                 </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><span class="card-label">Kernel Logs</span></div>
            <div id="log-container" style="font-family: 'JetBrains Mono'; font-size: 12px; color: var(--text-muted); overflow: hidden; display: flex; flex-direction: column; gap: 8px;">
                <div>[init] Dashboard initialized.</div>
            </div>
        </div>

    </div>

    <script>
        // üåì Theme Logic
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('theme-icon');
            const text = document.getElementById('theme-text');
            if (body.getAttribute('data-theme') === 'light') {
                body.setAttribute('data-theme', 'dark');
                icon.innerText = '‚òÄÔ∏é'; text.innerText = 'Light Mode';
            } else {
                body.setAttribute('data-theme', 'light');
                icon.innerText = '‚òæ'; text.innerText = 'Dark Mode';
            }
        }

        // üîó WebSocket Setup
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const wsUrl = `${protocol}//${host}/ws`;
        console.log("Connecting to:", wsUrl);
        
        const ws = new WebSocket(wsUrl);
        const statusDot = document.getElementById('ws-status');
        const logs = document.getElementById('log-container');

        // TPS Logic
        let packetCount = 0;
        setInterval(() => {
            document.getElementById('tps').innerText = packetCount.toLocaleString();
            packetCount = 0;
        }, 1000);

        function addLog(msg, color) {
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            div.innerHTML = `<span style="color:#555">[${time}]</span> <span style="color:${color || 'inherit'}">${msg}</span>`;
            logs.prepend(div);
            if(logs.children.length > 8) logs.lastElementChild.remove();
        }

        ws.onopen = () => {
            console.log("Connected");
            statusDot.classList.add('status-connected');
            addLog("Connected to Rust WebSocket", "#10b981");
        };
        ws.onclose = () => {
            console.log("Disconnected");
            statusDot.classList.remove('status-connected');
            addLog("Disconnected from server", "#ef4444");
        };

        // üé® 2D Map Logic (The Magic Part)
        const canvas = document.getElementById('trackCanvas');
        const ctx = canvas.getContext('2d');
        const mapContainer = document.getElementById('map-container');
        
        const pathData = []; 
        let minX = Infinity, maxX = -Infinity;
        let minY = Infinity, maxY = -Infinity;

        function resizeCanvas() {
            canvas.width = mapContainer.clientWidth;
            canvas.height = mapContainer.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        ws.onmessage = (event) => {
            // 1. Parse
            const d = JSON.parse(event.data);
            packetCount++;

            // 2. Map Auto-Scaling Logic
            const x = d.x;
            const y = d.y; 
            pathData.push({x, y});
            
            if (x < minX) minX = x;
            if (x > maxX) maxX = x;
            if (y < minY) minY = y;
            if (y > maxY) maxY = y;

            // 3. Draw Frame
            const padding = 60; 
            const width = canvas.width - padding * 2;
            const height = canvas.height - padding * 2;
            
            const rangeX = Math.abs(maxX - minX) || 1;
            const rangeY = Math.abs(maxY - minY) || 1;
            const scale = Math.min(width / rangeX, height / rangeY);

            const offsetX = (canvas.width - rangeX * scale) / 2 - minX * scale;
            const offsetY = (canvas.height - rangeY * scale) / 2 - minY * scale;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Trace (Past)
            if (pathData.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--text-sub');
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                
                // Draw all points
                pathData.forEach((p, i) => {
                    const drawX = p.x * scale + offsetX;
                    const drawY = canvas.height - (p.y * scale + offsetY);
                    if (i === 0) ctx.moveTo(drawX, drawY);
                    else ctx.lineTo(drawX, drawY);
                });
                ctx.stroke();
            }

            // Draw Current Position (Glowing Dot)
            const currX = x * scale + offsetX;
            const currY = canvas.height - (y * scale + offsetY);

            ctx.beginPath();
            ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--brand-color');
            ctx.shadowBlur = 20; 
            ctx.shadowColor = ctx.fillStyle;
            ctx.arc(currX, currY, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // 4. Update UI
            document.getElementById('speed').innerText = d.speed.toFixed(0);
            document.getElementById('gear').innerText = d.gear;
            document.getElementById('xyz-val').innerHTML = 
                `X: <span style="color:var(--text-main)">${d.x.toFixed(0)}</span><br> 
                 Y: <span style="color:var(--text-main)">${d.y.toFixed(0)}</span><br>
                 Z: <span style="color:var(--text-main)">${d.z.toFixed(0)}</span>`;

            const thr = d.throttle;
            const brk = d.brake > 0 ? 100 : 0; 
            document.getElementById('thr-bar').style.width = thr + "%";
            document.getElementById('thr-val').innerText = thr.toFixed(0) + "%";
            document.getElementById('brk-bar').style.width = brk + "%";
            document.getElementById('brk-val').innerText = brk > 0 ? "ON" : "OFF";
        };
    </script>
</body>
</html>
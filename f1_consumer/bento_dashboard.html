<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Lights Out - Hybrid System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;900&family=JetBrains+Mono:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-page: #050505;       
            --bg-card: #111111;       
            --border-color: #262626;  
            --text-main: #e5e5e5;     
            --text-dim: #737373;      
            
            --brand-color: #4f46e5;
            --col-speed: #38bdf8;     
            --col-throttle: #4ade80;  
            --col-brake: #f87171;     
        }

        * { box-sizing: border-box; }
        body {
            background-color: var(--bg-page); color: var(--text-main); font-family: 'Inter', sans-serif;
            margin: 0; padding: 20px; height: 100vh; overflow: hidden;
        }

        /* --- COMMON UTILS --- */
        .hidden { display: none !important; }
        .btn-back {
            background: #222; border: 1px solid var(--border-color); color: white;
            padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-back:hover { background: #333; }

        /* =========================================
           VIEW 1: BENTO DASHBOARD (Overview)
           ========================================= */
        #view-dashboard {
            display: grid; gap: 20px; width: 100%; height: 100%; max-width: 1600px; margin: 0 auto;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: 60px 1fr 1fr; /* Header - Row1 - Row2 */
        }

        .dash-header { grid-column: span 4; display: flex; justify-content: space-between; align-items: center; }
        .project-title { font-weight: 900; font-size: 24px; letter-spacing: -1px; }

        .bento-card {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 20px;
            padding: 24px; display: flex; flex-direction: column; position: relative; overflow: hidden;
            transition: transform 0.2s, border-color 0.2s;
        }
        .bento-card:hover { border-color: #444; }
        .card-title { font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }

        /* Specific Cards */
        .card-map { 
            grid-column: span 2; grid-row: span 2; 
            cursor: pointer; /* ÌÅ¥Î¶≠ Í∞ÄÎä• ÌëúÏãú */
        }
        .card-map:hover { border-color: var(--brand-color); box-shadow: 0 0 30px rgba(79, 70, 229, 0.1); }
        
        .card-speed { grid-column: span 1; grid-row: span 1; display: flex; justify-content: center; align-items: center; text-align: center; }
        .speed-val { font-family: 'JetBrains Mono'; font-size: 80px; font-weight: 800; line-height: 0.9; }
        
        .card-inputs { grid-column: span 1; grid-row: span 1; }
        
        .card-system { grid-column: span 1; grid-row: span 1; }
        .card-logs { grid-column: span 1; grid-row: span 1; }

        .click-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); padding: 12px 24px; border-radius: 30px; border: 1px solid #444;
            font-size: 12px; font-weight: 600; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        .card-map:hover .click-hint { opacity: 1; }


        /* =========================================
           VIEW 2: ANALYSIS MODE (MoTeC Style)
           ========================================= */
        #view-analysis {
            display: grid; gap: 1px; width: 100%; height: 100%;
            background: var(--border-color); border: 1px solid var(--border-color);
            grid-template-columns: 280px 1fr 350px;
            grid-template-rows: 50px 1fr;
        }
        
        .ana-header { grid-column: span 3; background: var(--bg-page); display: flex; align-items: center; padding: 0 20px; border-bottom: 1px solid var(--border-color); justify-content: space-between; }
        .panel { background: var(--bg-card); padding: 20px; display: flex; flex-direction: column; }
        
        /* Analysis Specifics */
        .data-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; }
        .data-val { font-family: 'JetBrains Mono'; font-size: 16px; font-weight: 600; }
        
        .graph-stack { flex-grow: 1; display: flex; flex-direction: column; gap: 1px; background: #222; }
        .sub-graph { flex: 1; background: var(--bg-card); position: relative; }

        canvas { width: 100%; height: 100%; display: block; }
        
    </style>
</head>
<body>

    <div id="view-dashboard">
        <div class="dash-header">
            <div class="project-title">PROJECT <span style="color:var(--brand-color)">LIGHTS OUT</span></div>
            <div style="font-size: 12px; font-family: 'JetBrains Mono'; color: var(--text-dim);">SYSTEM ONLINE ‚Ä¢ <span id="dash-tps">0</span> TPS</div>
        </div>

        <div class="bento-card card-map" onclick="switchView('analysis')">
            <div class="card-title">üìç LIVE TRACKER (CLICK TO ANALYZE)</div>
            <div style="flex-grow: 1; position: relative;">
                <canvas id="bentoMapCanvas"></canvas>
                <div class="click-hint">‚Üó OPEN ANALYSIS VIEW</div>
            </div>
        </div>

        <div class="bento-card card-speed">
            <div>
                <div class="card-title">VELOCITY</div>
                <div class="speed-val" id="dash-speed">0</div>
                <div style="color: var(--text-dim); font-size: 14px; margin-top: 5px;">KM/H</div>
            </div>
        </div>

        <div class="bento-card card-inputs">
            <div class="card-title">PEDAL TELEMETRY</div>
            <div style="flex-grow: 1; display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex:1; height:100%; background:#1a1a1a; border-radius:4px; position:relative; overflow:hidden;">
                    <div id="dash-thr-bar" style="position:absolute; bottom:0; width:100%; height:0%; background:var(--col-throttle); transition:height 0.05s;"></div>
                    <div style="position:absolute; top:10px; width:100%; text-align:center; font-size:10px;">THR</div>
                </div>
                <div style="flex:1; height:100%; background:#1a1a1a; border-radius:4px; position:relative; overflow:hidden;">
                    <div id="dash-brk-bar" style="position:absolute; bottom:0; width:100%; height:0%; background:var(--col-brake); transition:height 0.05s;"></div>
                    <div style="position:absolute; top:10px; width:100%; text-align:center; font-size:10px;">BRK</div>
                </div>
            </div>
        </div>

        <div class="bento-card card-system">
            <div class="card-title">BACKEND HEALTH</div>
            <div style="margin-top: auto;">
                <div class="data-row" style="border:none; padding:4px 0;">
                    <span style="font-size:12px; color:#666;">LATENCY</span>
                    <span style="font-family:'JetBrains Mono'; color:#fff;">0.01 ms</span>
                </div>
                <div class="data-row" style="border:none; padding:4px 0;">
                    <span style="font-size:12px; color:#666;">PROTOCOL</span>
                    <span style="font-family:'JetBrains Mono'; color:var(--brand-color);">Zero-Copy</span>
                </div>
            </div>
        </div>

        <div class="bento-card card-logs">
            <div class="card-title">KERNEL LOGS</div>
            <div id="dash-logs" style="font-family:'JetBrains Mono'; font-size:10px; color:#555; overflow:hidden; height:100%; display:flex; flex-direction:column-reverse;">
                <div>[init] Dashboard Ready</div>
            </div>
        </div>
    </div>


    <div id="view-analysis" class="hidden">
        <div class="ana-header">
            <div style="font-weight:700;">DATA ANALYSIS MODE</div>
            <button class="btn-back" onclick="switchView('dashboard')">
                <span>‚úï</span> CLOSE
            </button>
        </div>

        <div class="panel">
            <div style="font-size:10px; color:#666; margin-bottom:20px;">TELEMETRY DATA</div>
            <div style="text-align:center; margin-bottom:30px;">
                <div style="font-size:80px; font-weight:800; font-family:'JetBrains Mono'; line-height:1;" id="ana-gear">-</div>
                <div style="font-size:12px; color:#666;">GEAR</div>
            </div>
            <div class="data-row"><span>SPEED</span> <span class="data-val" id="ana-speed">0</span></div>
            <div class="data-row"><span>RPM</span> <span class="data-val" id="ana-rpm">0</span></div>
            <div class="data-row"><span>THROTTLE</span> <span class="data-val" style="color:var(--col-throttle)" id="ana-thr">0%</span></div>
            <div class="data-row"><span>BRAKE</span> <span class="data-val" style="color:var(--col-brake)" id="ana-brk">OFF</span></div>
        </div>

        <div class="panel" style="padding:0;">
            <div class="graph-stack">
                <div class="sub-graph" style="flex:2;">
                    <div style="position:absolute; top:10px; left:10px; font-size:10px; color:var(--col-speed);">SPEED TRACE</div>
                    <canvas id="chartSpeed"></canvas>
                </div>
                <div class="sub-graph" style="flex:1;">
                    <div style="position:absolute; top:10px; left:10px; font-size:10px; color:#666;">INPUTS</div>
                    <canvas id="chartInputs"></canvas>
                </div>
            </div>
        </div>

        <div class="panel">
            <div style="font-size:10px; color:#666; margin-bottom:10px;">TRACK POSITION</div>
            <div style="flex-grow:1; position:relative;">
                <canvas id="anaMapCanvas"></canvas>
            </div>
            <div style="font-family:'JetBrains Mono'; font-size:10px; color:#555; margin-top:10px;">
                X: <span id="ana-x" style="color:#aaa;">0</span> 
                Y: <span id="ana-y" style="color:#aaa;">0</span>
            </div>
        </div>
    </div>


    <script>
        // --- STATE MANAGEMENT ---
        let currentView = 'dashboard';

        function switchView(viewName) {
            currentView = viewName;
            if(viewName === 'analysis') {
                document.getElementById('view-dashboard').classList.add('hidden');
                document.getElementById('view-analysis').classList.remove('hidden');
                resizeAnalysis(); // Resize charts when visible
            } else {
                document.getElementById('view-analysis').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                resizeBento();
            }
        }

        // --- WEBSOCKET ---
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const ws = new WebSocket(`${protocol}//${host}/ws`);

        // --- DATA STORES ---
        const windowSize = 400;
        const history = {
            speed: new Array(windowSize).fill(0),
            throttle: new Array(windowSize).fill(0),
            brake: new Array(windowSize).fill(0)
        };
        const pathData = [];
        let bounds = { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity };
        let packetCount = 0;

        // --- CANVAS CONTEXTS ---
        // Bento View
        const ctxBentoMap = document.getElementById('bentoMapCanvas').getContext('2d');
        // Analysis View
        const ctxAnaMap = document.getElementById('anaMapCanvas').getContext('2d');
        const ctxSpeed = document.getElementById('chartSpeed').getContext('2d');
        const ctxInput = document.getElementById('chartInputs').getContext('2d');

        // --- RESIZE LOGIC ---
        function resizeBento() {
            const c = document.getElementById('bentoMapCanvas');
            c.width = c.parentElement.clientWidth;
            c.height = c.parentElement.clientHeight;
        }
        function resizeAnalysis() {
            const c1 = document.getElementById('anaMapCanvas');
            c1.width = c1.parentElement.clientWidth;
            c1.height = c1.parentElement.clientHeight;
            
            const c2 = document.getElementById('chartSpeed');
            c2.width = c2.parentElement.clientWidth;
            c2.height = c2.parentElement.clientHeight;

            const c3 = document.getElementById('chartInputs');
            c3.width = c3.parentElement.clientWidth;
            c3.height = c3.parentElement.clientHeight;
        }
        window.addEventListener('resize', () => {
            if(currentView === 'dashboard') resizeBento();
            else resizeAnalysis();
        });
        // Initial Resize
        setTimeout(() => { resizeBento(); resizeAnalysis(); }, 100);


        // --- MAIN LOOP ---
        setInterval(() => {
            document.getElementById('dash-tps').innerText = packetCount.toLocaleString();
            packetCount = 0;
        }, 1000);

        ws.onmessage = (e) => {
            const d = JSON.parse(e.data);
            packetCount++;

            // 1. Common Data Update
            pathData.push({x: d.x, y: d.y});
            if(d.x < bounds.minX) bounds.minX = d.x; if(d.x > bounds.maxX) bounds.maxX = d.x;
            if(d.y < bounds.minY) bounds.minY = d.y; if(d.y > bounds.maxY) bounds.maxY = d.y;
            
            history.speed.shift(); history.speed.push(d.speed);
            history.throttle.shift(); history.throttle.push(d.throttle);
            history.brake.shift(); history.brake.push(d.brake > 0 ? 100 : 0);

            // 2. Render Active View ONLY
            if (currentView === 'dashboard') {
                renderBento(d);
            } else {
                renderAnalysis(d);
            }
        };


        // --- RENDERING FUNCTIONS ---
        
        function renderBento(d) {
            // Text/Bars
            document.getElementById('dash-speed').innerText = d.speed.toFixed(0);
            document.getElementById('dash-thr-bar').style.height = d.throttle + "%";
            document.getElementById('dash-brk-bar').style.height = (d.brake>0?100:0) + "%";
            
            // Map
            drawMap(ctxBentoMap, true); // true = simplified drawing
        }

        function renderAnalysis(d) {
            // Text
            document.getElementById('ana-gear').innerText = d.gear;
            document.getElementById('ana-speed').innerText = d.speed.toFixed(0);
            document.getElementById('ana-rpm').innerText = d.rpm.toFixed(0);
            document.getElementById('ana-thr').innerText = d.throttle.toFixed(0) + "%";
            document.getElementById('ana-brk').innerText = d.brake>0 ? "ON" : "OFF";
            document.getElementById('ana-x').innerText = d.x.toFixed(0);
            document.getElementById('ana-y').innerText = d.y.toFixed(0);

            // Graphs
            drawGraph(ctxSpeed, history.speed, "#38bdf8", 350, true);
            drawInputGraph(ctxInput);
            drawMap(ctxAnaMap, false); // false = detailed drawing
        }

        // --- DRAWING HELPERS ---
        function drawMap(ctx, simple) {
            const w = ctx.canvas.width; const h = ctx.canvas.height;
            const pad = simple ? 20 : 40;
            const rx = Math.abs(bounds.maxX - bounds.minX)||1;
            const ry = Math.abs(bounds.maxY - bounds.minY)||1;
            const scale = Math.min((w-pad*2)/rx, (h-pad*2)/ry);
            const ox = (w - rx*scale)/2 - bounds.minX*scale;
            const oy = (h - ry*scale)/2 - bounds.minY*scale;

            ctx.clearRect(0,0,w,h);
            
            // Draw Trace
            if(pathData.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = simple ? "#444" : "#555";
                ctx.lineWidth = simple ? 1.5 : 2;
                // Optimization: Draw simpler path for Bento
                const step = simple ? 2 : 1; 
                for(let i=0; i<pathData.length; i+=step) {
                    const p = pathData[i];
                    const x = p.x*scale + ox; const y = h - (p.y*scale + oy);
                    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                }
                ctx.stroke();
            }
            // Draw Dot
            if(pathData.length>0) {
                const last = pathData[pathData.length-1];
                const lx = last.x*scale + ox; const ly = h - (last.y*scale + oy);
                ctx.beginPath(); ctx.fillStyle = "#fff";
                ctx.shadowBlur = simple ? 5 : 10; ctx.shadowColor="#fff";
                ctx.arc(lx, ly, simple?3:4, 0, Math.PI*2);
                ctx.fill(); ctx.shadowBlur=0;
            }
        }

        function drawGraph(ctx, data, color, max, fill) {
            const w = ctx.canvas.width; const h = ctx.canvas.height;
            const step = w/(windowSize-1);
            ctx.clearRect(0,0,w,h);
            
            // Grid
            ctx.strokeStyle="#222"; ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();

            ctx.beginPath(); ctx.strokeStyle=color; ctx.lineWidth=2;
            for(let i=0; i<windowSize; i++) {
                const x = i*step; const y = h - (data[i]/max)*h;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
            if(fill) {
                ctx.lineTo(w,h); ctx.lineTo(0,h); 
                ctx.fillStyle=color+"20"; ctx.fill();
            }
        }

        function drawInputGraph(ctx) {
            const w = ctx.canvas.width; const h = ctx.canvas.height;
            const step = w/(windowSize-1);
            ctx.clearRect(0,0,w,h);
            
            // Throttle (Green)
            ctx.beginPath(); ctx.strokeStyle="#4ade80"; ctx.lineWidth=1;
            for(let i=0; i<windowSize; i++) {
                ctx[i===0?'moveTo':'lineTo'](i*step, h - (history.throttle[i]/100)*h);
            }
            ctx.stroke();
            // Brake (Red)
            ctx.beginPath(); ctx.strokeStyle="#f87171"; ctx.lineWidth=1;
            for(let i=0; i<windowSize; i++) {
                ctx[i===0?'moveTo':'lineTo'](i*step, h - (history.brake[i]/100)*h);
            }
            ctx.stroke();
        }

    </script>
</body>
</html>